# 配置参考

[English](CONFIGURATION.md) | [中文](CONFIGURATION.zh-CN.md)

币安傅里叶回测器中所有可配置参数的完整参考。

## 目录

1. [环境变量](#环境变量)
2. [数据加载参数](#数据加载参数)
3. [傅里叶分析参数](#傅里叶分析参数)
4. [信号生成参数](#信号生成参数)
5. [止损参数](#止损参数)
6. [回测配置](#回测配置)
7. [仓位规模参数](#仓位规模参数)
8. [多时间框架参数](#多时间框架参数)
9. [优化参数](#优化参数)
10. [投资组合参数](#投资组合参数)
11. [预设和默认值](#预设和默认值)

---

## 环境变量

这些在 `.env` 文件中配置。

### 数据路径

| 变量 | 类型 | 默认值 | 描述 |
|----------|------|---------|-------------|
| `BASE_PATH` | string | `./data` | 所有数据存储的基础目录 |
| `CACHE_DIR` | string | `./data/cache` | Parquet 缓存文件目录 |

**示例**：
```bash
BASE_PATH=/mnt/storage/trading_data
CACHE_DIR=/mnt/storage/trading_data/cache
```

### 币安 API 设置

| 变量 | 类型 | 默认值 | 描述 |
|----------|------|---------|-------------|
| `BINANCE_BASE_URL` | string | `https://api.binance.com` | 币安 API 端点 |
| `BINANCE_API_KEY` | string | *（空）* | 可选 API 密钥以获得更高速率限制 |
| `BINANCE_API_SECRET` | string | *（空）* | 可选 API 密钥 |
| `BINANCE_RATE_LIMIT_PER_MINUTE` | int | `1200` | 每分钟最大请求数 |
| `BINANCE_REQUEST_TIMEOUT` | int | `30` | 请求超时（秒） |

**注意**：
- 公共市场数据的 API 密钥是可选的
- 速率限制：无密钥 1200/分钟，认证请求更高
- 使用测试网 URL `https://testnet.binance.vision` 进行测试

### 交易默认值

| 变量 | 类型 | 默认值 | 描述 |
|----------|------|---------|-------------|
| `DEFAULT_FEE_RATE` | float | `0.001` | 默认交易手续费（0.1%） |
| `DEFAULT_SLIPPAGE_BPS` | float | `5.0` | 默认滑点（基点） |

**按交易所的手续费率**：
- 币安现货：0.1%（0.001）常规，0.075% 使用 BNB
- 币安期货：0.04% maker，0.0675% taker
- FTX：0.07% maker，0.02% taker（关闭前）

### 重试设置

| 变量 | 类型 | 默认值 | 范围 | 描述 |
|----------|------|---------|-------|-------------|
| `MAX_RETRY_ATTEMPTS` | int | `5` | 1-10 | 失败请求的重试次数 |
| `RETRY_INITIAL_WAIT` | float | `1.0` | 0.5-5.0 | 初始等待时间（秒） |
| `RETRY_MAX_WAIT` | float | `60.0` | 10-300 | 最大等待时间（秒） |

**指数退避公式**：
```
wait_time = min(RETRY_INITIAL_WAIT * (2 ** attempt), RETRY_MAX_WAIT)
```

### UI 预设存储

| 变量 | 类型 | 默认值 | 描述 |
|----------|------|---------|-------------|
| `PRESET_STORAGE_PATH` | string | `./data/presets/presets.yaml` | 保存的参数预设路径 |
| `LAST_SESSION_STATE_PATH` | string | `./data/presets/last_state.yaml` | 上次会话状态路径 |

---

## 数据加载参数

### 币种选择

| 参数 | 类型 | 选项 | 描述 |
|-----------|------|---------|-------------|
| `symbol` | string | BTCUSDT, ETHUSDT, BNBUSDT, ADAUSDT 等 | 要分析的交易对 |

**支持的币种**：在 `core/data/loader.py` → `SUPPORTED_SYMBOLS` 中定义

**添加新币种**：编辑 loader.py 中的 `SUPPORTED_SYMBOLS` 集合

### 时间间隔选择

| 参数 | 类型 | 选项 | 描述 |
|-----------|------|---------|-------------|
| `interval` | string | 30m, 1h, 4h | K线时间框架 |

**时间间隔含义**：
- `30m`：30 分钟（每天 48 根 K线）
- `1h`：1 小时（每天 24 根 K线）
- `4h`：4 小时（每天 6 根 K线）

**考虑因素**：
- 较低时间框架：更多数据，更高噪音，更多信号
- 较高时间框架：更少数据，更平滑的趋势，更少信号

### 日期范围

| 参数 | 类型 | 范围 | 描述 |
|-----------|------|-------|-------------|
| `start_date` | datetime | 2020-01-01 至今 | 数据范围开始 |
| `end_date` | datetime | `start_date` 至今 | 数据范围结束 |

**建议**：
- **测试**：3-6 个月用于快速验证
- **优化**：1-2 年用于稳健的参数搜索
- **步进式**：至少 2-3 年

**历史可用性**：
- 大多数交易对：从 2020 年或上市日期开始的数据
- 检查币安每个币种的历史数据可用性

### 强制刷新

| 参数 | 类型 | 默认值 | 描述 |
|-----------|------|---------|-------------|
| `force_refresh` | bool | `False` | 绕过缓存并获取新数据 |

**何时使用**：
- ✅ 测试数据管道更改
- ✅ 怀疑缓存损坏
- ✅ 验证最新数据
- ❌ 正常使用（慢且浪费）

---

## 傅里叶分析参数

### 最小趋势周期

| 参数 | 类型 | 范围 | 默认值 | 描述 |
|-----------|------|-------|---------|-------------|
| `min_trend_hours` | float | 6-168 | `24.0` | 要保留的最小趋势周期（小时） |

**转换为柱数**：
```python
min_period_bars = min_trend_hours / interval_hours
```

**示例**（1h 时间间隔）：
- 12 小时 → 12 柱（日内趋势）
- 24 小时 → 24 柱（日周期）
- 48 小时 → 48 柱（2 天波段）
- 168 小时 → 168 柱（周趋势）

**对策略的影响**：
- **较低值**：更敏感，捕获短期趋势，更多交易
- **较高值**：更平滑，捕获长期趋势，更少交易

**按时间间隔的建议**：
| 时间间隔 | 最小周期（小时） | 柱数 | 策略类型 |
|----------|-------------------|------|---------------|
| 30m | 12-24 | 24-48 | 剥头皮/日内交易 |
| 1h | 24-48 | 24-48 | 日内交易 |
| 4h | 48-168 | 12-42 | 波段交易 |

### 截止缩放

| 参数 | 类型 | 范围 | 默认值 | 描述 |
|-----------|------|-------|---------|-------------|
| `cutoff_scale` | float | 0.3-3.0 | `1.0` | 截止频率的乘数 |

**效果**：
```python
actual_cutoff = (1.0 / min_period_bars) * cutoff_scale
```

- **< 1.0**：更多平滑（更低的截止频率）
  - 0.5：截止的一半，保留 2 倍长的趋势
  - 效果：更平滑的线，更少的噪音引起的信号
  
- **= 1.0**：在最小趋势周期处精确截止
  
- **> 1.0**：更少平滑（更高的截止频率）
  - 2.0：截止的两倍，允许更短的趋势
  - 效果：对价格变化更敏感，更多信号

**调优指南**：
| 市场状况 | 推荐缩放 |
|-----------------|------------------|
| 高波动率（2021 年加密货币） | 0.5-0.7 |
| 正常波动率 | 0.8-1.2 |
| 低波动率（稳定币对） | 1.5-2.5 |

### 频谱分析参数

| 参数 | 类型 | 范围 | 默认值 | 描述 |
|-----------|------|-------|---------|-------------|
| `window_length` | int | 64-512 | `256` | Welch PSD 的窗口大小（柱） |
| `overlap_ratio` | float | 0.0-0.75 | `0.5` | 窗口之间的重叠 |

**窗口长度**：
- **太小**（< 64）：频率分辨率差，频谱噪音
- **最优**（128-256）：大多数用例的良好平衡
- **太大**（> 512）：窗口少，估计方差高

**重叠比率**：
- **0%**：无重叠，最大独立性
- **50%**：标准，良好的方差减少
- **75%**：高重叠，最平滑的估计但较慢

**性能影响**：
| 窗口长度 | 重叠 | 计算时间 |
|--------------|---------|-----------------|
| 64 | 50% | 快（< 1s） |
| 256 | 50% | 中等（约 2s） |
| 512 | 75% | 慢（约 5s） |

---

## 信号生成参数

### 斜率阈值

| 参数 | 类型 | 范围 | 默认值 | 描述 |
|-----------|------|-------|---------|-------------|
| `slope_threshold` | float | -0.01 到 0.01 | `0.0` | 进入信号的最小趋势斜率 |

**单位**：斜率以价格/柱为单位（例如，BTC 在 40k 美元时 $100/柱约为 0.0025 或 0.25%）

**计算**：
```python
slope[t] = (smoothed[t] - smoothed[t - lookback]) / lookback
```

**效果**：
- **0.0**：在任何上升趋势上进入（价格高于平滑）
- **> 0.0**：需要最小动量
  - 0.0001：非常弱的过滤器
  - 0.001：中等过滤器（推荐）
  - 0.01：强过滤器（仅陡峭趋势）

**建议**：
| 市场 | 斜率阈值 |
|-------|-----------------|
| 高波动率（BTC） | 0.0005-0.001 |
| 中波动率（ETH） | 0.0003-0.0007 |
| 低波动率（稳定币） | 0.0001-0.0003 |

### 斜率回溯

| 参数 | 类型 | 范围 | 默认值 | 描述 |
|-----------|------|-------|---------|-------------|
| `slope_lookback` | int | 1-10 | `3` | 用于斜率计算的柱数 |

**效果**：
- **1**：即时斜率（噪音）
- **3-5**：平滑斜率（推荐）
- **> 5**：非常平滑（滞后）

---

## 止损参数

### 止损类型

| 参数 | 类型 | 选项 | 默认值 | 描述 |
|-----------|------|---------|---------|-------------|
| `stop_type` | string | `atr`, `residual` | `atr` | 止损计算方法 |

**ATR（平均真实范围）**：
- 基于波动率
- 适应市场状况
- 适用于突破策略

**残差**：
- 基于价格-趋势偏差
- 更紧的控制
- 适用于趋势跟踪

### ATR 参数

| 参数 | 类型 | 范围 | 默认值 | 描述 |
|-----------|------|-------|---------|-------------|
| `atr_period` | int | 5-50 | `14` | ATR 计算周期 |
| `k_stop` | float | 1.0-5.0 | `2.0` | 止损 ATR 乘数 |
| `k_profit` | float | 1.5-8.0 | `3.0` | 止盈 ATR 乘数 |

**ATR 周期**：
- **较短**（5-10）：对波动率变化更敏感
- **标准**（14）：经典技术分析默认值
- **较长**（20-30）：更平滑，对噪音不太敏感

**K 止损**：
```python
stop_loss = entry_price - k_stop * ATR
```
- **1.5**：紧止损，更多退出
- **2.0**：标准，良好的平衡
- **3.0**：宽止损，更少假突破

**K 止盈**：
```python
take_profit = entry_price + k_profit * ATR
```
- **应 > k_stop** 以获得正风险/收益
- **典型比率**：1.5:1 到 3:1（止盈:止损）

### 残差参数

| 参数 | 类型 | 范围 | 默认值 | 描述 |
|-----------|------|-------|---------|-------------|
| `residual_window` | int | 10-100 | `20` | 残差标准差窗口 |
| `k_stop` | float | 1.0-5.0 | `2.0` | 止损 sigma 乘数 |
| `k_profit` | float | 1.5-8.0 | `3.0` | 止盈 sigma 乘数 |

**残差窗口**：
- **较短**（10-20）：对偏差变化更敏感
- **标准**（20-30）：平衡灵敏度和稳定性
- **较长**（50-100）：更稳定但滞后

---

## 回测配置

### 资金设置

| 参数 | 类型 | 范围 | 默认值 | 描述 |
|-----------|------|-------|---------|-------------|
| `initial_capital` | float | 1000-1000000 | `10000.0` | 起始投资组合价值 |

**建议**：
- **测试**：$10,000（标准）
- **生产模拟**：实际账户规模
- **缩放结果**：指标独立于资金（%返回相同）

### 交易成本

| 参数 | 类型 | 范围 | 默认值 | 描述 |
|-----------|------|-------|---------|-------------|
| `fee_rate` | float | 0.0-0.01 | `0.001` | 每笔交易手续费（十进制） |
| `slippage` | float | 0.0-0.01 | `0.0005` | 每笔交易滑点（十进制） |

**手续费率**：
- **0.0001**（0.01%）：VIP 或 maker 手续费
- **0.001**（0.1%）：标准现货交易
- **0.002**（0.2%）：保守估计

**滑点**：
- **0.0001**（0.01%）：高流动性
- **0.0005**（0.05%）：标准（推荐）
- **0.001**（0.1%）：低流动性

**总成本示例**（往返）：
```
费用 = 2 * 0.001 = 0.2%
滑点 = 2 * 0.0005 = 0.1%
总计 = 0.3% 每往返
```

### 做空设置

| 参数 | 类型 | 默认值 | 描述 |
|-----------|------|---------|-------------|
| `allow_short` | bool | `False` | 启用做空交易 |

**启用时**：
- 做空进入：价格 < 平滑且斜率 < 0
- 做空退出：价格 > 平滑或触及止损
- 手续费/滑点同样适用

---

## 仓位规模参数

### 规模方法

| 参数 | 类型 | 选项 | 默认值 | 描述 |
|-----------|------|---------|---------|-------------|
| `sizing_method` | string | `fixed`, `volatility`, `risk_parity` | `fixed` | 仓位规模算法 |

**固定**：
- 每笔交易固定资金百分比
- 简单，可预测
- 不适应风险

**波动率**：
- 根据 ATR 或 sigma 缩放
- 标准化风险
- 推荐用于多币种

**风险平价**：
- 等风险贡献
- 需要协方差矩阵
- 用于投资组合模式

### 固定规模

| 参数 | 类型 | 范围 | 默认值 | 描述 |
|-----------|------|-------|---------|-------------|
| `position_size_pct` | float | 0.01-1.0 | `0.1` | 每笔交易的资金百分比 |

**示例**：
- 资金：$10,000
- 规模 %：10%（0.1）
- 仓位：$1,000

**建议**：
- **保守**：5-10%
- **中等**：10-20%
- **激进**：20-50%（高风险）

### 波动率规模

| 参数 | 类型 | 范围 | 默认值 | 描述 |
|-----------|------|-------|---------|-------------|
| `volatility_target` | float | 0.005-0.05 | `0.02` | 目标投资组合波动率（日） |

**计算**：
```python
position_size = equity * (volatility_target / asset_volatility)
```

**目标选择**：
- **0.01**（1%）：低风险
- **0.02**（2%）：中等（推荐）
- **0.05**（5%）：高风险

---

## 多时间框架参数

### MTF 启用

| 参数 | 类型 | 默认值 | 描述 |
|-----------|------|---------|-------------|
| `use_mtf` | bool | `False` | 启用多时间框架确认 |

**启用时**：
- 需要更高时间框架数据
- 仅当所有时间框架对齐时才进入
- 减少交易，更高质量

### MTF 时间框架

| 参数 | 类型 | 选项 | 描述 |
|-----------|------|---------|-------------|
| `mtf_higher_interval` | string | 1h, 4h, 1d | 更高时间框架用于确认 |

**组合**：
| 执行时间框架 | 确认时间框架 | 用例 |
|----------------|---------------------|---------|
| 30m | 1h, 4h | 日内，波段确认 |
| 1h | 4h, 1d | 波段，趋势确认 |
| 4h | 1d, 1w | 位置，主趋势 |

---

## 优化参数

### 搜索方法

| 参数 | 类型 | 选项 | 默认值 | 描述 |
|-----------|------|---------|---------|-------------|
| `search_method` | string | `grid`, `random`, `bayesian` | `grid` | 优化算法 |

**网格**：
- 详尽搜索
- 最慢但最彻底
- 用于小参数空间

**随机**：
- 采样 N 个随机点
- 更快，可扩展
- 用于大空间

**贝叶斯**：
- 智能搜索
- 最高效
- 用于昂贵的评估

### 目标指标

| 参数 | 类型 | 选项 | 默认值 | 描述 |
|-----------|------|---------|---------|-------------|
| `objective_metric` | string | `sharpe`, `sortino`, `calmar`, `total_return` | `sharpe` | 要优化的指标 |

**夏普比率**：
- 风险调整收益
- 标准选择
- 惩罚波动率

**索提诺比率**：
- 仅下行风险
- 适用于不对称回报
- 忽略上行波动率

**Calmar 比率**：
- 收益/最大回撤
- 关注最坏情况
- 适用于风险厌恶

**总收益**：
- 绝对利润
- 忽略风险
- 可能过拟合

---

## 投资组合参数

### 加权方法

| 参数 | 类型 | 选项 | 默认值 | 描述 |
|-----------|------|---------|---------|-------------|
| `weight_method` | string | `equal`, `volatility`, `risk_parity`, `market_cap` | `equal` | 投资组合加权方案 |

**等权**：
- 1/N 分配
- 简单多样化
- 忽略风险差异

**波动率**：
- 逆波动率加权
- 标准化风险
- 倾向低波动率资产

**风险平价**：
- 等风险贡献
- 真正平衡
- 计算密集

**市值**：
- 按市值加权
- 跟踪市场
- 集中在大型资产

### 再平衡

| 参数 | 类型 | 选项 | 默认值 | 描述 |
|-----------|------|---------|---------|-------------|
| `rebalance_frequency` | string | `daily`, `weekly`, `monthly` | `weekly` | 再平衡频率 |
| `rebalance_threshold` | float | 0.0-0.5 | `0.05` | 触发再平衡的偏差 |

**频率**：
- **每日**：紧密跟踪，高手续费
- **每周**：平衡控制和成本
- **每月**：低手续费，更多漂移

**阈值**：
- **5%**：标准，平衡频率
- **10%**：更少再平衡，更多漂移
- **2%**：频繁再平衡，更高成本

---

## 预设和默认值

### 保守预设

```yaml
min_trend_hours: 48
cutoff_scale: 0.7
atr_period: 20
k_stop: 2.5
k_profit: 4.0
position_size_pct: 0.05
```

**特征**：
- 更长趋势
- 更宽止损
- 较小仓位
- 更少交易

### 标准预设

```yaml
min_trend_hours: 24
cutoff_scale: 1.0
atr_period: 14
k_stop: 2.0
k_profit: 3.0
position_size_pct: 0.1
```

**特征**：
- 平衡设置
- 推荐起点
- 适合大多数市场

### 激进预设

```yaml
min_trend_hours: 12
cutoff_scale: 1.5
atr_period: 10
k_stop: 1.5
k_profit: 2.5
position_size_pct: 0.2
```

**特征**：
- 更短趋势
- 更紧止损
- 较大仓位
- 更多交易

---

## 参数相互作用

### 趋势周期 vs. 时间间隔

| 时间间隔 | 推荐最小趋势（小时） | 策略类型 |
|----------|---------------------------|----------------|
| 30m | 12-24 | 剥头皮 |
| 1h | 24-48 | 日内 |
| 4h | 48-168 | 波段 |

### 止损 vs. 仓位规模

**紧止损 + 大仓位**：
- 高频率交易
- 更多假突破
- 需要高胜率

**宽止损 + 小仓位**：
- 较少交易
- 更少假突破
- 更低胜率可接受

### 平滑 vs. 信号

**更多平滑（低截止缩放）**：
- 更少信号
- 更高质量
- 可能错过趋势

**更少平滑（高截止缩放）**：
- 更多信号
- 更多噪音
- 捕获更多移动

---

## 验证和限制

### 参数验证

系统会自动验证：
- 范围检查（例如，k_profit > k_stop）
- 类型检查（int、float、bool）
- 依赖检查（例如，MTF 需要更高时间框架数据）

### 已知限制

1. **最小数据要求**：
   - min_trend_period 的 2 倍用于平滑
   - FFT 的 64+ 柱
   - 优化的 100+ 柱

2. **计算限制**：
   - 网格搜索：< 1000 个组合推荐
   - Welch 窗口：< 数据长度的 1/2
   - 投资组合符号：< 20 用于性能

3. **市场特定**：
   - 加密 24/7：无周末缺口
   - 高波动率：调整止损
   - 低流动性：增加滑点

---

有关架构详细信息，请参阅 [ARCHITECTURE.zh-CN.md](ARCHITECTURE.zh-CN.md)。
有关常见问题，请参阅 [FAQ.zh-CN.md](FAQ.zh-CN.md)。
